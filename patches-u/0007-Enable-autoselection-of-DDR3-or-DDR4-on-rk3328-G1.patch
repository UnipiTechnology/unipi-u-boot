From fd90465bafe13e4f3aa76029d7a6f554964fb9a7 Mon Sep 17 00:00:00 2001
From: Miroslav Ondra <ondra@faster.cz>
Date: Tue, 3 Feb 2026 14:09:31 +0100
Subject: [PATCH 7/7] Enable autoselection of DDR3 or DDR4 on rk3328 (G1)

---
 arch/arm/dts/rk3328-rock-pi-e-u-boot.dtsi |  1 +
 drivers/ram/rockchip/sdram_rk3328.c       | 28 ++++++++++++++++++-----
 include/bloblist.h                        |  1 +
 3 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/arch/arm/dts/rk3328-rock-pi-e-u-boot.dtsi b/arch/arm/dts/rk3328-rock-pi-e-u-boot.dtsi
index 8e82f6a6..bda5dccc 100644
--- a/arch/arm/dts/rk3328-rock-pi-e-u-boot.dtsi
+++ b/arch/arm/dts/rk3328-rock-pi-e-u-boot.dtsi
@@ -2,3 +2,4 @@
 
 #include "rk3328-rock-pi-e-base-u-boot.dtsi"
 #include "rk3328-sdram-ddr3-666.dtsi"
+#include "rk3328-sdram-ddr4-666a.dtsi"
diff --git a/drivers/ram/rockchip/sdram_rk3328.c b/drivers/ram/rockchip/sdram_rk3328.c
index 99690d67..abbf6264 100644
--- a/drivers/ram/rockchip/sdram_rk3328.c
+++ b/drivers/ram/rockchip/sdram_rk3328.c
@@ -29,6 +29,7 @@ struct dram_info {
 	struct rk3328_cru *cru;
 	struct msch_regs *msch;
 	struct rk3328_ddr_grf_regs *ddr_grf;
+	int again;
 #endif
 	struct ram_info info;
 	struct rk3328_grf_regs *grf;
@@ -480,7 +481,8 @@ static int sdram_init_detect(struct dram_info *dram,
 	memcpy(&sdram_ch, &sdram_params->ch,
 	       sizeof(struct rk3328_sdram_channel));
 
-	sdram_init(dram, sdram_params, 0);
+	if (sdram_init(dram, sdram_params, 0) != 0)
+		return -1;
 	dram_detect_cap(dram, sdram_params, 0);
 
 	/* modify bw, cs related timing */
@@ -493,7 +495,8 @@ static int sdram_init_detect(struct dram_info *dram,
 		sdram_ch.noc_timings.ddrtiming.b.bwratio = 1;
 
 	/* reinit sdram by real dram cap */
-	sdram_init(dram, sdram_params, 1);
+	if (sdram_init(dram, sdram_params, 1) != 0)
+		return -1;
 
 	/* redetect cs1 row */
 	sdram_detect_cs1_row(cap_info, sdram_params->base.dramtype);
@@ -521,8 +524,9 @@ static int rk3328_dmc_init(struct udevice *dev)
 	struct rk3328_sdram_params *params = &plat->sdram_params;
 #else
 	struct dtd_rockchip_rk3328_dmc *dtplat = &plat->dtplat;
-	struct rk3328_sdram_params *params =
-					(void *)dtplat->rockchip_sdram_params;
+	struct rk3328_sdram_params *params = (priv->again==0)?
+					(void *)dtplat->rockchip_sdram_params :
+					(void *)dtplat->rockchip_sdram_params_again;
 
 	ret = conv_of_plat(dev);
 	if (ret)
@@ -541,7 +545,9 @@ static int rk3328_dmc_init(struct udevice *dev)
 	ret = sdram_init_detect(priv, params);
 	if (ret < 0) {
 		printf("%s DRAM init failed%d\n", __func__, ret);
-		return ret;
+		if (priv->again) return ret;
+		priv->again = 1;
+		return rk3328_dmc_init(dev);
 	}
 
 	return 0;
@@ -552,8 +558,9 @@ static int rk3328_dmc_of_to_plat(struct udevice *dev)
 #if CONFIG_IS_ENABLED(OF_REAL)
 	struct rockchip_dmc_plat *plat = dev_get_plat(dev);
 	int ret;
+	struct dram_info *priv = dev_get_priv(dev);
 
-	ret = dev_read_u32_array(dev, "rockchip,sdram-params",
+	ret = dev_read_u32_array(dev, priv->again==0 ? "rockchip,sdram-params" : "rockchip,sdram-params-again",
 				 (u32 *)&plat->sdram_params,
 				 sizeof(plat->sdram_params) / sizeof(u32));
 	if (ret) {
@@ -570,6 +577,15 @@ static int rk3328_dmc_of_to_plat(struct udevice *dev)
 
 #endif
 
+
+#ifdef CONFIG_TPL_BUILD
+int rk3328_dmc_get_ddr_mode(struct udevice *dev)
+{
+	struct dram_info *priv = dev_get_priv(dev);
+	return priv->again;
+}
+#endif
+
 static int rk3328_dmc_probe(struct udevice *dev)
 {
 #ifdef CONFIG_TPL_BUILD
diff --git a/include/bloblist.h b/include/bloblist.h
index f32faf78..4ed396e4 100644
--- a/include/bloblist.h
+++ b/include/bloblist.h
@@ -153,6 +153,7 @@ enum bloblist_tag_t {
 	BLOBLISTT_U_BOOT_SPL_HANDOFF	= 0xfff000, /* Hand-off info from SPL */
 	BLOBLISTT_VBE			= 0xfff001, /* VBE per-phase state */
 	BLOBLISTT_U_BOOT_VIDEO		= 0xfff002, /* Video info from SPL */
+	BLOBLISTT_UNIPI_DDR 		= 0xfff055, /* DRAM info */
 };
 
 /**
-- 
2.39.5

